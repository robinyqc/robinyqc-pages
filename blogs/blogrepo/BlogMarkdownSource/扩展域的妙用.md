# 扩展域的妙用

扩域的形式化定义是，若域 $\mathbb{K}$ 是域 $\mathbb{F}$ 的子域，那么 $\mathbb{F}$ 是 $\mathbb{K}$ 的扩域。域的定义那些相信大家都清楚，就不详细说了。（如果不清楚的话，对下面实际应用的理解也并无影响。）

当我们需要附加信息的时候我们可以用扩展域来简化过程（就像矩阵），特别是，附加信息在当前域中不存在。

最常见的用法是处理递推加速。就拿斐波那契数列举例。

#### 例一. 斐波那契数列

> 已知 $f_i = f_{i - 1} + f_{i - 2}(i > 2), f_1 = 1, f_2 = 1$。求 $f_n \bmod 2^{32} (n\leq 10^{18})$。

用各种手段我们都能得到斐波那契数列的通项公式：$f_n = \dfrac{\left(\frac{(1 + \sqrt 5)}2\right)^n - \left(\frac{(1 - \sqrt 5)}2\right)^n}{\sqrt 5}$。然后快速幂不就行了吗？结果发现 $\sqrt 5 $ 在模 $2^{32}$ 意义下不存在（没有二次剩余）！

但是答案里没有 $\sqrt 5$。所以我们把 $\sqrt 5$ 提出来最后再求解，也许就可以了呢。注意到，$\left(\frac{(1 + \sqrt 5)}2\right)^n$ 的结果也一定是 $a + b \sqrt 5$ 的形式。我们把所有数写成二元组 $(a, b)$，表示这个数实际值为 $a + b\sqrt 5$。那么两个数 $(a, b)$ 和 $(c, d)$ 相乘，答案是 $(ac + 5bd, ad + bc)$（因为 $(a + b\sqrt 5)(c + d\sqrt 5) = ac + 5bd + ad\sqrt 5 + bc\sqrt 5$）。相加比较简单，答案是 $(a + c, b + d)$。

诶，我们发现这样可以快速幂了。由于最后答案是整数，$\sqrt 5$ 的项会被约掉，自然是正确的。

***

其实复数也是可以看做扩展域——实数域的扩域，因为虚数现实中并不存在，我们用它来简化计算却很有用。个人觉得像是 FFT 之类的就是复数简化计算的例子。

多扯一下，上面的斐波那契通项求解用的“扩域” $\{a + b\sqrt 5\mid a, b\in \mathbb{Z}_{2^{32}}\}$ 中我们并没有定义逆元。其实它确实不一定有逆元，所以它其实不算域。如果模数是质数应该是有逆元的。

另外扩展域的实现是很简单的。只需要新开一个类重载运算符，真的，几行就搞定了。

***

#### 例二. 没有逆元

> 你需要维护一个可重集合，可以往里面加入一个整数 $x$；让集合内每个数乘上 $x$；求整个集合的和（对 $2^{32}$ 取模）。

这个题有很多做法，但是扩展域一定是最方便的一种。

首先你一定会做模数是质数的：维护一个值 $k$，表示当前集合内每个数实际上是实际值的 $\frac 1k$。加入一个数时，将其乘上 $\frac 1k$ 再加入，这样相对比例不变；乘上 $x$ 时，直接将 $k$ 乘上 $x$，询问时，输出所有数的和乘上 $k$。由于要乘法逆元，总复杂度 $O(n\log V)$。

然而任何偶数在模 $2^{32}$ 意义下没有逆元。不存在就扩一个嘛，因为答案是存在的。定义 $x = (a, b)$ 表示这个数的值为 $a \times 2^b$（$a$ 为奇数）。不妨令 $b\leq d$，那么 $(a, b)\times (c, d) = (ac, b + d)$，$(a, b) + (c, d) = (a + c \times 2^{d - b}, d)$（因为 $b\leq d$，故 $d - b\geq 0$，那么 $2^{d - b}$ 在模意义下存在，可以放进原来的域里面）。现在我们可以定义逆元，$(a, b)^{-1} = (a ^ {-1}, -b)$。现在所有需要的运算都有了，剩下的和原问题一模一样了。